<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Harmony Elite | Super Admin Command</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #0f172a; }
    .bg-coop-green { background-color: #059669; }
    .text-coop-green { color: #059669; }
    .sidebar-link.active { background-color: #f1f5f9; color: #059669; font-weight: 800; border-right: 4px solid #059669; }
    .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .glass-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
    .stat-card:hover { transform: translateY(-5px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
  </style>
</head>

<body class="flex min-h-screen">

  <div id="repayModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-[500]">
    <div class="bg-white rounded-[3rem] p-10 w-full max-sm:m-4 max-w-md shadow-2xl border border-slate-100">
        <div class="text-center mb-8">
            <h3 class="text-2xl font-black text-slate-900 uppercase italic">Admin Collection</h3>
            <p id="repayMemberName" class="text-emerald-600 font-bold text-sm mt-1"></p>
        </div>
        <div class="space-y-4">
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Amount to Collect (₦)</label>
                <input type="number" id="adminRepayAmount" class="w-full p-5 rounded-2xl bg-slate-50 border border-slate-100 font-black text-xl outline-none focus:ring-4 focus:ring-emerald-500/10">
            </div>
            <button id="confirmAdminRepay" class="w-full py-5 bg-slate-900 text-white rounded-2xl font-black uppercase tracking-widest hover:bg-black transition shadow-xl">Post Collection</button>
            <button onclick="closeRepayModal()" class="w-full py-3 text-slate-400 font-bold text-[10px] uppercase tracking-widest">Cancel</button>
        </div>
    </div>
  </div>

  <div id="authOverlay" class="fixed inset-0 z-[1000] bg-slate-900 flex items-center justify-center p-4 backdrop-blur-xl">
    <div class="bg-white p-12 rounded-[3rem] w-full max-w-md shadow-2xl text-center border border-slate-100">
        <div class="w-20 h-20 bg-emerald-600 rounded-[2rem] flex items-center justify-center text-white font-black mx-auto mb-8 text-3xl shadow-xl shadow-emerald-200">H</div>
        <h2 class="text-3xl font-black mb-2 tracking-tighter">Elite Command</h2>
        <p class="text-slate-400 text-sm mb-10 font-medium">Authorization required for system access</p>
        <div class="space-y-4">
            <input type="text" id="adminUser" placeholder="Admin Username" class="w-full p-5 bg-slate-50 rounded-2xl outline-none border border-transparent focus:border-emerald-500 focus:bg-white transition-all font-semibold">
            <input type="password" id="adminPass" placeholder="Access Key" class="w-full p-5 bg-slate-50 rounded-2xl outline-none border border-transparent focus:border-emerald-500 focus:bg-white transition-all text-center font-bold tracking-widest">
        </div>
        <button onclick="handleAdminLogin()" class="w-full bg-slate-900 text-white p-5 rounded-2xl font-black mt-8 hover:bg-black transition-all shadow-lg active:scale-95">UNLOCKED TERMINAL</button>
    </div>
  </div>

  <div id="globalModal" class="fixed inset-0 z-[1100] flex items-center justify-center hidden bg-slate-900/40 backdrop-blur-md p-4">
    <div class="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden border border-white/20 p-10 text-center">
        <div id="modalBody"></div>
        <button onclick="closeModal()" class="w-full bg-slate-900 text-white py-4 rounded-2xl text-sm font-black hover:bg-black transition-all mt-6 shadow-lg">DISMISS</button>
    </div>
  </div>

  <aside class="w-80 bg-white border-r border-slate-100 hidden lg:block sticky top-0 h-screen z-40">
    <div class="p-10">
      <div class="flex items-center space-x-4 mb-16">
        <div class="w-12 h-12 bg-emerald-600 rounded-2xl flex items-center justify-center text-white font-black shadow-lg shadow-emerald-100">H</div>
        <div>
            <h2 class="text-xl font-black text-slate-800 tracking-tighter leading-none">Harmony</h2>
            <span class="text-[10px] font-bold text-emerald-600 uppercase tracking-widest">Corporate Elite</span>
        </div>
      </div>
      <nav class="space-y-3">
        <a href="#" onclick="showTab(event, 'overview')" class="sidebar-link active flex items-center px-6 py-4 rounded-2xl transition-all text-sm font-bold uppercase tracking-tight">Executive Summary</a>
        <a href="#" onclick="showTab(event, 'loans')" class="sidebar-link flex items-center px-6 py-4 rounded-2xl transition-all text-sm font-bold uppercase tracking-tight">Authorization Queue</a>
        <a href="#" onclick="showTab(event, 'recovery')" class="sidebar-link flex items-center px-6 py-4 rounded-2xl transition-all text-sm font-bold uppercase tracking-tight">Recovery Oversight</a>
        <a href="#" onclick="showTab(event, 'history')" class="sidebar-link flex items-center px-6 py-4 rounded-2xl transition-all text-sm font-bold uppercase tracking-tight">Master Audit Log</a>
      </nav>

      <div class="absolute bottom-10 left-10 right-10 p-6 bg-slate-50 rounded-[2rem] border border-slate-100">
          <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">System Integrity</p>
          <div class="flex items-center text-emerald-500 font-bold text-xs uppercase">
              <span class="w-2 h-2 bg-emerald-500 rounded-full mr-2 animate-pulse"></span> Encrypted Core
          </div>
      </div>
    </div>
  </aside>

  <main class="flex-1 p-6 lg:p-16 overflow-y-auto">
    <header class="mb-12 flex flex-col md:flex-row justify-between items-center gap-6">
        <div>
            <h1 class="text-4xl font-black text-slate-900 tracking-tighter" id="greeting">System Command</h1>
            <p class="text-slate-500 font-medium text-lg">Financial Governance & Risk Management</p>
        </div>
        <div class="flex items-center space-x-4">
            <div class="relative">
                <input type="text" id="adminTrackInput" onkeyup="filterHistory()" placeholder="Search Ledger..." class="pl-12 pr-6 py-4 bg-white border border-slate-200 rounded-2xl text-xs font-bold outline-none focus:ring-4 ring-emerald-100 w-72 transition-all">
                <svg class="w-4 h-4 absolute left-5 top-1/2 -translate-y-1/2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <button onclick="fetchLoans()" class="bg-white border border-slate-200 p-4 rounded-2xl hover:bg-slate-50 transition shadow-sm active:scale-95">
                <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            </button>
        </div>
    </header>

    <section id="overview" class="tab-content active">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
            <div class="bg-white p-10 rounded-[3rem] border border-slate-100 shadow-xl shadow-slate-200/40 stat-card">
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-[0.2em] mb-4">Gross Disbursements</p>
                <h3 class="text-4xl font-black text-slate-900 tracking-tighter" id="statOut">₦0.00</h3>
                <div class="mt-4 flex items-center text-emerald-600 text-[10px] font-bold">Capital Deployed</div>
            </div>
            <div class="bg-slate-900 p-10 rounded-[3rem] shadow-2xl stat-card">
                <p class="text-[10px] text-slate-500 font-black uppercase tracking-[0.2em] mb-4">Total Receivables</p>
                <h3 class="text-4xl font-black text-white tracking-tighter" id="statDebt">₦0.00</h3>
                <div class="mt-4 flex items-center text-rose-400 text-[10px] font-bold uppercase">Active Liability</div>
            </div>
            <div class="bg-white p-10 rounded-[3rem] border border-slate-100 shadow-xl shadow-slate-200/40 stat-card">
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-[0.2em] mb-4">Approval Requests</p>
                <h3 class="text-4xl font-black text-emerald-600 tracking-tighter" id="pendingCount">00</h3>
                <p class="text-[10px] font-bold text-slate-400 mt-4 uppercase">Awaiting Authorization</p>
            </div>
        </div>
    </section>

    <section id="loans" class="tab-content">
        <div class="bg-white rounded-[3rem] border border-slate-100 overflow-hidden shadow-xl shadow-slate-200/30">
            <div class="p-10 border-b flex justify-between items-center">
                <div>
                    <h3 class="text-2xl font-black text-slate-900 tracking-tighter">Authorization Queue</h3>
                    <p class="text-sm text-slate-400 font-medium">Verify and approve fund disbursements</p>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-[10px] font-black uppercase tracking-widest text-slate-400 border-b">
                        <tr>
                            <th class="px-10 py-6">Beneficiary Details</th>
                            <th class="px-10 py-6 text-center">Proposed Sum (NGN)</th>
                            <th class="px-10 py-6 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="loanTableBody" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="recovery" class="tab-content">
        <div class="mb-10 flex flex-col md:flex-row md:items-end justify-between gap-4">
            <h3 class="text-3xl font-black text-slate-900 tracking-tighter">Active Debt Portfolio</h3>
            <input type="text" id="debtSearchInput" onkeyup="filterDebtPortfolio()" placeholder="Search Name..." class="pl-6 pr-6 py-4 bg-white border border-slate-200 rounded-2xl text-xs font-bold outline-none w-80">
        </div>
        <div id="recoveryStats" class="grid grid-cols-1 lg:grid-cols-2 gap-8"></div>
    </section>

    <section id="history" class="tab-content">
        <div class="bg-white rounded-[3rem] border border-slate-100 shadow-xl overflow-hidden">
            <div class="p-10 border-b flex justify-between items-center bg-slate-900">
                <div class="text-white">
                    <h3 class="text-2xl font-black">Master Ledger</h3>
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Global Record</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="exportToCSV()" class="bg-emerald-600 text-white px-6 py-4 rounded-2xl text-[11px] font-black uppercase">Export CSV</button>
                    <button onclick="printMasterLog()" class="bg-white text-slate-900 px-6 py-4 rounded-2xl text-[11px] font-black uppercase">PDF Log</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-[10px] font-black uppercase text-slate-400">
                        <tr>
                            <th class="px-10 py-8">Reference</th>
                            <th class="px-10 py-8">Member Name</th>
                            <th class="px-10 py-8">Status</th>
                            <th class="px-10 py-8 text-right">Value</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
        </div>
    </section>
  </main>

  <script>
    const API_URL = 'https://sheetdb.io/api/v1/b9cm231d1i0he';
    let allRecords = [];
    const ADMIN_CREDS = { user: "Admin", pass: "Salako2024" };

    function handleAdminLogin() {
        const u = document.getElementById('adminUser').value;
        const p = document.getElementById('adminPass').value;
        if(u === ADMIN_CREDS.user && p === ADMIN_CREDS.pass) {
            document.getElementById('authOverlay').classList.add('hidden');
            fetchLoans();
        } else { alert("ACCESS DENIED"); }
    }

    async function fetchLoans() {
      try {
        const res = await fetch(API_URL);
        allRecords = await res.json();
        updateDashboard();
      } catch (e) { console.error("Data Fetch Error", e); }
    }

    function updateDashboard() {
        const totalOut = allRecords.reduce((acc, curr) => acc + (Number(curr.amount) || 0), 0);
        const totalDebt = allRecords.reduce((acc, curr) => acc + (Number(curr.balance) || 0), 0);
        const pending = allRecords.filter(r => r.status === 'Pending');

        document.getElementById('statOut').innerText = `₦${totalOut.toLocaleString()}`;
        document.getElementById('statDebt').innerText = `₦${totalDebt.toLocaleString()}`;
        document.getElementById('pendingCount').innerText = pending.length.toString().padStart(2, '0');

        renderApplications(pending);
        renderRecoveryOversight();
        renderHistory();
    }

    function renderApplications(pending) {
        const body = document.getElementById('loanTableBody');
        body.innerHTML = pending.map(loan => `
            <tr class="hover:bg-slate-50/80 transition-all">
                <td class="px-10 py-8">
                    <p class="font-extrabold text-slate-900 uppercase">${loan.fullName}</p>
                    <p class="text-[10px] font-mono text-emerald-600">ID: ${loan.trackingId}</p>
                </td>
                <td class="px-10 py-8">
                    <input type="number" id="amt-${loan.trackingId}" value="${loan.amount}" class="bg-white border-2 border-slate-100 rounded-xl px-5 py-3 font-black w-40 text-center">
                </td>
                <td class="px-10 py-8 text-right">
                    <button onclick="approveLoan('${loan.trackingId}')" class="bg-slate-900 text-white px-6 py-4 rounded-2xl text-[10px] font-black uppercase">Grant</button>
                </td>
            </tr>
        `).join('') || '<tr><td colspan="3" class="p-10 text-center text-slate-400">Queue Empty</td></tr>';
    }

    async function approveLoan(id) {
        const finalAmt = document.getElementById(`amt-${id}`).value;
        if (!finalAmt || Number(finalAmt) <= 0) return alert("Invalid amount");

        const btn = window.event.target;
        btn.innerText = "Syncing...";
        btn.disabled = true;

        try {
            const res = await fetch(`${API_URL}/trackingId/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    status: 'Approved',
                    amount: finalAmt,
                    balance: finalAmt 
                })
            });

            if(res.ok) {
                const loan = allRecords.find(l => l.trackingId === id);
                triggerModal('Authorized', `Funds released for ${loan.fullName}`);
                generateEliteAuthPDF(loan, finalAmt);
                fetchLoans(); 
            }
        } catch (e) { alert("Network Error"); }
        finally { btn.innerText = "Grant"; btn.disabled = false; }
    }

    function renderRecoveryOversight() {
        const container = document.getElementById('recoveryStats');
        const debtors = allRecords.filter(r => parseFloat(r.balance) > 0);

        container.innerHTML = debtors.map(loan => `
            <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
                <h4 class="font-black text-slate-900 text-lg uppercase mb-1">${loan.fullName}</h4>
                <p class="text-[10px] font-bold text-slate-400 mb-4">${loan.trackingId}</p>
                <p class="text-2xl font-black text-slate-900 mb-6">₦${Number(loan.balance).toLocaleString()}</p>
                <button onclick="openRepayModal('${loan.trackingId}')" class="w-full py-4 bg-emerald-600 text-white rounded-2xl font-black text-[11px] uppercase">Process Collection</button>
            </div>
        `).join('') || '<div class="col-span-full p-10 text-center text-slate-400">No active debt.</div>';
    }

    function openRepayModal(id) {
        const loan = allRecords.find(l => l.trackingId === id);
        document.getElementById('repayMemberName').innerText = loan.fullName;
        document.getElementById('repayModal').classList.remove('hidden');
        document.getElementById('confirmAdminRepay').onclick = () => processAdminRepay(id);
    }

    function closeRepayModal() { document.getElementById('repayModal').classList.add('hidden'); }

    async function processAdminRepay(id) {
        const loan = allRecords.find(l => l.trackingId === id);
        const paid = parseFloat(document.getElementById('adminRepayAmount').value);
        if(!paid || paid <= 0) return alert("Invalid amount");

        const newBal = Math.max(0, Number(loan.balance) - paid);
        const btn = document.getElementById('confirmAdminRepay');
        btn.innerText = "Syncing..."; btn.disabled = true;

        try {
            const res = await fetch(`${API_URL}/trackingId/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    balance: newBal,
                    status: newBal <= 0 ? 'Liquidated' : 'Paid'
                })
            });
            if(res.ok) { closeRepayModal(); fetchLoans(); }
        } catch (e) { alert("Sync Failed"); }
        finally { btn.innerText = "Post Collection"; btn.disabled = false; }
    }

    function renderHistory() {
        const body = document.getElementById('historyTableBody');
        body.innerHTML = allRecords.map(item => `
            <tr class="history-row">
                <td class="px-10 py-6 font-mono text-[10px] font-bold text-emerald-600">${item.trackingId}</td>
                <td class="px-10 py-6 font-black text-slate-800 uppercase">${item.fullName}</td>
                <td class="px-10 py-6"><span class="px-3 py-1 rounded-xl text-[9px] font-black uppercase bg-slate-100">${item.status}</span></td>
                <td class="px-10 py-6 font-black text-right">₦${Number(item.amount).toLocaleString()}</td>
            </tr>
        `).reverse().join('');
    }

    function showTab(e, tabId) {
      e.preventDefault();
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      e.currentTarget.classList.add('active');
    }

    function generateEliteAuthPDF(loan, finalAmt) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFillColor(15, 23, 42); doc.rect(0, 0, 210, 50, 'F');
        doc.setTextColor(255, 255, 255); doc.setFontSize(22); doc.text("HARMONY ELITE AUTHORIZATION", 20, 30);
        doc.setTextColor(15, 23, 42); doc.setFontSize(12);
        doc.text(`Beneficiary: ${loan.fullName.toUpperCase()}`, 20, 70);
        doc.text(`Reference: ${loan.trackingId}`, 20, 80);
        doc.setFontSize(16); doc.text(`Authorized Sum: NGN ${Number(finalAmt).toLocaleString()}`, 20, 100);
        doc.save(`Auth_${loan.trackingId}.pdf`);
    }

    function triggerModal(title, message) {
        document.getElementById('modalBody').innerHTML = `<h3 class="text-2xl font-black mb-2">${title}</h3><p class="text-slate-500">${message}</p>`;
        document.getElementById('globalModal').classList.remove('hidden');
    }
    function closeModal() { document.getElementById('globalModal').classList.add('hidden'); }
    
    function filterHistory() {
        const val = document.getElementById('adminTrackInput').value.toLowerCase();
        document.querySelectorAll('.history-row').forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(val) ? '' : 'none';
        });
    }

    function exportToCSV() {
        const headers = ["ID", "Name", "Sum", "Bal", "Status"];
        const rows = allRecords.map(r => [r.trackingId, `"${r.fullName}"`, r.amount, r.balance, r.status]);
        const csv = [headers, ...rows].map(e => e.join(",")).join("\n");
        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Ledger_Export.csv"; link.click();
    }
  </script>
</body>
</html>
