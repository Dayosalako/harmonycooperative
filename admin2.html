<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Harmony Elite | Super Admin Command</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #0f172a; }
    .bg-coop-green { background-color: #059669; }
    .text-coop-green { color: #059669; }
    .sidebar-link.active { background-color: #f1f5f9; color: #059669; font-weight: 800; border-right: 4px solid #059669; }
    .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Advanced UI Effects from your original code */
    .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
    .shimmer { background: linear-gradient(90deg, #f0f0f0 25%, #f8f8f8 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 2s infinite; }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
  </style>
</head>
<body class="bg-slate-50 flex min-h-screen overflow-hidden">

  <div id="authOverlay" class="fixed inset-0 z-[1000] bg-slate-900 flex items-center justify-center p-4">
    <div class="bg-white p-12 rounded-[3rem] w-full max-w-md shadow-2xl text-center">
        <div class="w-20 h-20 bg-emerald-600 rounded-3xl flex items-center justify-center text-white font-black mx-auto mb-8 text-3xl">H</div>
        <h2 class="text-3xl font-black mb-2 tracking-tighter italic">Elite Access</h2>
        <p class="text-slate-400 text-sm mb-10">Administrative Clearance Required</p>
        <div class="space-y-4">
            <input type="password" id="adminPass" placeholder="Enter Command Key" class="w-full p-5 bg-slate-50 rounded-2xl outline-none border border-transparent focus:border-emerald-500 font-bold text-center tracking-widest">
            <button onclick="checkAuth()" class="w-full bg-slate-900 text-white p-5 rounded-2xl font-black hover:bg-black transition-all shadow-xl">AUTHENTICATE</button>
        </div>
    </div>
  </div>

  <aside class="w-80 bg-white border-r border-slate-200 flex flex-col h-screen sticky top-0">
    <div class="p-8 border-b border-slate-100">
      <h1 class="text-xl font-black tracking-tighter text-slate-900 italic">HARMONY <span class="text-emerald-600">ELITE</span></h1>
      <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">Super Admin Command</p>
    </div>
    
    <nav class="flex-1 p-6 space-y-2 overflow-y-auto">
      <button onclick="showTab('dashboard')" class="sidebar-link active w-full flex items-center p-4 rounded-xl transition-all" id="link-dashboard">
        <span class="text-xs uppercase font-black tracking-widest">Executive Summary</span>
      </button>
      <button onclick="showTab('auth')" class="sidebar-link w-full flex items-center p-4 rounded-xl transition-all" id="link-auth">
        <span class="text-xs uppercase font-black tracking-widest">Authorization Queue</span>
      </button>
      <button onclick="showTab('recovery')" class="sidebar-link w-full flex items-center p-4 rounded-xl transition-all" id="link-recovery">
        <span class="text-xs uppercase font-black tracking-widest">Recovery Oversight</span>
      </button>
      <button onclick="showTab('audit')" class="sidebar-link w-full flex items-center p-4 rounded-xl transition-all" id="link-audit">
        <span class="text-xs uppercase font-black tracking-widest">Master Audit Log</span>
      </button>
      <div class="pt-10">
          <p class="text-[9px] font-black text-slate-300 uppercase px-4 mb-4 tracking-widest">Reports & Data</p>
          <button onclick="exportToCSV()" class="w-full flex items-center p-4 text-slate-500 hover:text-emerald-600 font-bold text-xs uppercase italic tracking-wider">Export Ledger (CSV)</button>
          <button onclick="window.location.reload()" class="w-full flex items-center p-4 text-slate-500 hover:text-rose-600 font-bold text-xs uppercase italic tracking-wider">Refresh Terminal</button>
      </div>
    </nav>
    
    <div class="p-8 border-t border-slate-100">
      <div class="flex items-center gap-3">
          <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
          <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">System Online</p>
      </div>
    </div>
  </aside>

  <main class="flex-1 p-12 overflow-y-auto h-screen bg-slate-50">
    
    <div class="grid grid-cols-4 gap-6 mb-12">
      <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Portfolio</p>
        <p id="statOut" class="text-2xl font-black text-slate-900 tracking-tighter">₦0</p>
      </div>
      <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Debt</p>
        <p id="statDebt" class="text-2xl font-black text-rose-600 tracking-tighter">₦0</p>
      </div>
      <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
        <p id="pendingLabel" class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Pending Approvals</p>
        <p id="pendingCount" class="text-2xl font-black text-emerald-600 tracking-tighter">0</p>
      </div>
      <div class="bg-slate-900 p-8 rounded-[2.5rem] shadow-xl text-white">
        <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Active Members</p>
        <p id="activeMembers" class="text-2xl font-black tracking-tighter">0</p>
      </div>
    </div>

    <section id="tab-dashboard" class="tab-content active">
        <div class="grid grid-cols-1 gap-8">
            <div class="bg-white p-10 rounded-[3rem] border border-slate-100 shadow-sm">
                <h3 class="text-xl font-black text-slate-900 uppercase italic mb-8">System Analytics</h3>
                <div class="h-64 flex items-end gap-2 px-4">
                    <div class="flex-1 bg-emerald-100 rounded-t-xl h-[40%]"></div>
                    <div class="flex-1 bg-emerald-200 rounded-t-xl h-[60%]"></div>
                    <div class="flex-1 bg-emerald-400 rounded-t-xl h-[80%]"></div>
                    <div class="flex-1 bg-emerald-600 rounded-t-xl h-[55%]"></div>
                    <div class="flex-1 bg-slate-900 rounded-t-xl h-[95%]"></div>
                </div>
            </div>
        </div>
    </section>

    <section id="tab-auth" class="tab-content">
      <header class="mb-10">
        <h2 class="text-4xl font-black text-slate-900 tracking-tighter italic">Authorization Queue</h2>
        <p class="text-slate-400 font-bold uppercase text-[10px] tracking-widest mt-2">Executive Fund Release Protocol</p>
      </header>
      <div id="authList" class="grid grid-cols-1 gap-4"></div>
    </section>

    <section id="tab-recovery" class="tab-content">
      <header class="mb-10 flex justify-between items-end">
        <div>
            <h2 class="text-4xl font-black text-slate-900 tracking-tighter italic text-rose-600">Recovery Oversight</h2>
            <p class="text-slate-400 font-bold uppercase text-[10px] tracking-widest mt-2">Live Debt Collection Monitoring</p>
        </div>
        <div class="flex gap-4">
            <input type="text" id="recoverySearch" onkeyup="filterRecovery()" placeholder="Search Debtors..." class="p-4 bg-white border rounded-2xl text-xs font-bold outline-none w-64 shadow-sm">
        </div>
      </header>
      <div id="recoveryStats" class="grid grid-cols-2 gap-6"></div>
    </section>

    <section id="tab-audit" class="tab-content">
      <header class="mb-10">
        <h2 class="text-4xl font-black text-slate-900 tracking-tighter italic">Master Audit Log</h2>
        <p class="text-slate-400 font-bold uppercase text-[10px] tracking-widest mt-2">Complete Ledger of Financial Movements</p>
      </header>
      <div class="bg-white rounded-[3rem] border border-slate-100 overflow-hidden shadow-sm">
        <table class="w-full text-left">
          <thead class="bg-slate-50 text-[10px] font-black uppercase tracking-widest text-slate-400 border-b">
            <tr>
              <th class="p-8">Reference</th>
              <th class="p-8">Member</th>
              <th class="p-8">Initial</th>
              <th class="p-8">Balance</th>
              <th class="p-8">Status</th>
            </tr>
          </thead>
          <tbody id="auditLogTable" class="divide-y divide-slate-50"></tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="repayModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden flex items-center justify-center z-[500] p-4">
    <div class="bg-white rounded-[3rem] p-12 w-full max-w-md shadow-2xl">
        <div class="text-center mb-10">
            <div class="w-16 h-16 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center text-2xl mx-auto mb-4 font-black">₦</div>
            <h3 class="text-2xl font-black text-slate-900 uppercase italic">Admin Repayment</h3>
            <p id="repayMemberName" class="text-emerald-600 font-bold text-sm tracking-tight"></p>
        </div>
        <div class="space-y-6">
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">Amount to Deduct (₦)</label>
                <input type="number" id="adminRepayAmount" class="w-full p-6 rounded-2xl bg-slate-50 border border-slate-100 font-black text-2xl outline-none focus:ring-4 ring-emerald-500/10" placeholder="0.00">
            </div>
            <button id="confirmAdminRepay" class="w-full py-6 bg-slate-900 text-white rounded-2xl font-black uppercase tracking-widest hover:bg-black transition-all shadow-xl active:scale-95">Sync to Ledger</button>
            <button onclick="closeRepayModal()" class="w-full py-2 text-slate-300 font-bold text-[10px] uppercase tracking-widest">Cancel Transaction</button>
        </div>
    </div>
  </div>

  <div id="globalModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur hidden flex items-center justify-center z-[2000] p-4">
      <div class="bg-white rounded-[3rem] p-10 w-full max-w-sm text-center shadow-2xl">
          <div id="modalIcon" class="mb-6"></div>
          <h3 id="modalTitle" class="text-2xl font-black text-slate-900 uppercase italic mb-2"></h3>
          <p id="modalMsg" class="text-slate-500 font-medium mb-8"></p>
          <button onclick="closeModal()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black uppercase tracking-widest text-xs">Acknowledge</button>
      </div>
  </div>

  <script>
    const API_URL = 'https://sheetdb.io/api/v1/56k9183qayh5s';
    let allRecords = [];

    // AUTHENTICATION LOGIC
    function checkAuth() {
        const pass = document.getElementById('adminPass').value;
        if(pass === "Salako2024") {
            document.getElementById('authOverlay').style.display = 'none';
            fetchLoans();
        } else { alert("ACCESS DENIED: Command Key Invalid"); }
    }

    async function fetchLoans() {
      try {
        const response = await fetch(API_URL);
        allRecords = await response.json();
        updateDashboard();
      } catch (e) { console.error("Database Error"); }
    }

    function showTab(tab) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
      document.getElementById('tab-' + tab).classList.add('active');
      document.getElementById('link-' + tab).classList.add('active');
    }

    function triggerModal(title, msg, type="success") {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMsg').innerText = msg;
        document.getElementById('modalIcon').innerHTML = type === "success" 
            ? `<div class="w-16 h-16 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center text-2xl mx-auto italic">✓</div>`
            : `<div class="w-16 h-16 bg-rose-50 text-rose-600 rounded-full flex items-center justify-center text-2xl mx-auto italic">!</div>`;
        document.getElementById('globalModal').classList.remove('hidden');
    }

    function closeModal() { document.getElementById('globalModal').classList.add('hidden'); }

    function updateDashboard() {
      // Logic for the stats cards
      const totalOut = allRecords.reduce((acc, curr) => acc + (Number(curr.amount) || 0), 0);
      const totalDebt = allRecords.reduce((acc, curr) => acc + (Number(curr.balance) || 0), 0);
      const pendingCount = allRecords.filter(r => r.status === 'Pending').length;
      const activeCount = allRecords.filter(r => parseFloat(r.balance) > 0).length;

      document.getElementById('statOut').innerText = `₦${totalOut.toLocaleString()}`;
      document.getElementById('statDebt').innerText = `₦${totalDebt.toLocaleString()}`;
      document.getElementById('pendingCount').innerText = pendingCount;
      document.getElementById('activeMembers').innerText = activeCount;

      renderAuthorizationQueue();
      renderRecoveryOversight();
      renderMasterAuditLog();
    }

    function renderAuthorizationQueue() {
      const list = document.getElementById('authList');
      const pending = allRecords.filter(r => r.status === 'Pending');
      
      list.innerHTML = pending.map(loan => `
        <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm flex justify-between items-center group hover:border-emerald-200 transition-all">
          <div class="flex items-center gap-6">
            <div class="w-14 h-14 bg-slate-900 text-white rounded-2xl flex items-center justify-center font-black text-lg italic shadow-lg">A</div>
            <div>
              <h4 class="font-black text-slate-900 text-xl tracking-tighter uppercase">${loan.fullName}</h4>
              <p class="text-[10px] font-bold text-slate-400 tracking-[0.2em] mt-1">${loan.trackingId}</p>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <div class="relative">
              <span class="absolute left-4 top-1/2 -translate-y-1/2 font-black text-slate-300">₦</span>
              <input type="number" id="amt-${loan.trackingId}" value="${loan.amount}" class="pl-8 pr-4 py-4 w-40 bg-slate-50 rounded-xl border border-slate-100 font-black text-sm outline-none focus:ring-2 ring-emerald-500">
            </div>
            <button onclick="approveLoan('${loan.trackingId}')" class="px-8 py-4 bg-emerald-600 text-white rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-emerald-700 shadow-lg shadow-emerald-50 transition-all active:scale-95">Approve Funds</button>
          </div>
        </div>
      `).join('') || '<div class="py-20 text-center text-slate-300 font-black uppercase italic tracking-widest border-2 border-dashed rounded-[3rem]">No Pending Disbursements</div>';
    }

    async function approveLoan(id) {                    
      const loan = allRecords.find(l => l.trackingId === id);
      const finalAmtInput = document.getElementById(`amt-${id}`);
      const finalAmt = finalAmtInput ? finalAmtInput.value : loan.amount;
      
      const btn = event.target; 
      const originalText = btn.innerText;
      btn.innerText = "SYNCING..."; btn.disabled = true;

      try {
        const response = await fetch(`${API_URL}/trackingId/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'Approved', amount: finalAmt, balance: finalAmt })
        });

        if(response.ok) {
          triggerModal("Authorized Successfully", `Funds released for ${loan.fullName}. ID: ${id}`);
          generateEliteAuthPDF(loan, finalAmt);
          fetchLoans(); 
        }
      } catch (e) { alert("Authorization Sync Failed"); }
      finally { btn.innerText = originalText; btn.disabled = false; }
    }

    function renderRecoveryOversight() {
      const container = document.getElementById('recoveryStats');
      // THE FIX: Filter by Numeric Balance
      const activeDebts = allRecords.filter(r => {
        const b = parseFloat(r.balance);
        return !isNaN(b) && b > 0;
      });

      container.innerHTML = activeDebts.map(loan => `
        <div class="bg-white p-8 rounded-[3rem] border border-slate-100 shadow-sm hover:shadow-xl transition-all">
          <div class="flex justify-between mb-8">
            <div class="w-12 h-12 bg-slate-900 text-white rounded-2xl flex items-center justify-center font-black text-sm italic shadow-lg">R</div>
            <div class="text-right">
              <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Live Debt</p>
              <p class="text-2xl font-black text-rose-600 tracking-tighter">₦${Number(loan.balance).toLocaleString()}</p>
            </div>
          </div>
          <h4 class="font-black text-slate-900 uppercase text-lg mb-1">${loan.fullName}</h4>
          <p class="text-[10px] font-bold text-slate-400 tracking-widest mb-8 border-b border-slate-50 pb-4 italic">${loan.trackingId}</p>
          
          <div class="grid grid-cols-2 gap-3">
               <button onclick="sendWhatsAppReminder('${loan.phone}', '${loan.fullName}', '${loan.balance}')" class="py-4 bg-emerald-50 text-emerald-700 rounded-2xl font-black text-[9px] uppercase hover:bg-emerald-600 hover:text-white transition-all shadow-sm italic">WhatsApp</button>
               <button onclick="openRepaymentModal('${loan.trackingId}')" class="py-4 bg-slate-100 text-slate-700 rounded-2xl font-black text-[9px] uppercase hover:bg-slate-900 hover:text-white transition-all shadow-sm italic">Collect Payout</button>
          </div>
        </div>
      `).join('') || '<div class="col-span-full py-20 text-center text-slate-300 font-black uppercase italic tracking-widest">No Active Outstandings</div>';
    }

    function renderMasterAuditLog() {
      const body = document.getElementById('auditLogTable');
      body.innerHTML = allRecords.map(r => `
        <tr class="hover:bg-slate-50/50 transition-colors">
          <td class="p-8 font-mono text-[10px] font-bold text-slate-400 tracking-tighter">${r.trackingId}</td>
          <td class="p-8 font-black text-slate-700 text-sm uppercase">${r.fullName}</td>
          <td class="p-8 font-bold text-slate-400 text-sm italic">₦${Number(r.amount).toLocaleString()}</td>
          <td class="p-8 font-black text-rose-600 text-sm italic">₦${Number(r.balance).toLocaleString()}</td>
          <td class="p-8">
            <span class="px-4 py-2 text-[9px] font-black uppercase rounded-full border ${r.status === 'Approved' ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-slate-50 text-slate-400 border-slate-100'}">
                ${r.status}
            </span>
          </td>
        </tr>
      `).join('');
    }

    function generateEliteAuthPDF(loan, finalAmt) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const authTime = new Date().toLocaleString();
      const securityHash = btoa(loan.trackingId + finalAmt).substring(0, 16);

      // Header Design
      doc.setFillColor(15, 23, 42); doc.rect(0, 0, 210, 60, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFont("helvetica", "bold"); doc.setFontSize(28); doc.text("HARMONY ELITE", 20, 35);
      doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.text("EXECUTIVE FUND DISBURSEMENT AUTHORIZATION", 20, 45);

      // Body Section
      doc.setTextColor(15, 23, 42);
      doc.setFontSize(9); doc.text("AUTHORIZATION REFERENCE", 20, 80);
      doc.setFontSize(14); doc.setFont("helvetica", "bold"); doc.text(loan.trackingId, 20, 90);
      doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.text(authTime, 190, 90, {align: 'right'});

      // Main Content Box
      doc.setDrawColor(241, 245, 249); doc.setFillColor(248, 250, 252); doc.rect(20, 105, 170, 70, 'FD');
      doc.setTextColor(100); doc.setFontSize(10); doc.text("LEGAL BENEFICIARY", 35, 125);
      doc.setTextColor(15, 23, 42); doc.setFontSize(16); doc.text(loan.fullName.toUpperCase(), 35, 135);
      doc.setTextColor(5, 150, 105); doc.setFontSize(26); doc.text(`NGN ${Number(finalAmt).toLocaleString()}`, 35, 168);

      // Security Footer
      doc.setFillColor(248, 250, 252); doc.rect(0, 260, 210, 37, 'F');
      doc.setTextColor(150); doc.setFontSize(8);
      doc.text("SECURITY HASH: " + securityHash, 105, 282, {align: 'center'});
      doc.save(`AUTHORIZATION_${loan.trackingId}.pdf`);
    }

    function openRepaymentModal(id) {
        const loan = allRecords.find(l => l.trackingId === id);
        document.getElementById('repayMemberName').innerText = loan.fullName;
        document.getElementById('repayModal').classList.remove('hidden');
        document.getElementById('confirmAdminRepay').onclick = () => processAdminRepay(id);
    }

    function closeRepayModal() { document.getElementById('repayModal').classList.add('hidden'); }

    async function processAdminRepay(id) {
        const loan = allRecords.find(l => l.trackingId === id);
        const amtPaid = parseFloat(document.getElementById('adminRepayAmount').value);
        if(!amtPaid || amtPaid <= 0) return alert("Enter valid sum");
        const newBal = Math.max(0, Number(loan.balance) - amtPaid);

        try {
            const res = await fetch(`${API_URL}/trackingId/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ balance: newBal })
            });
            if(res.ok) { 
                triggerModal("Transaction Recorded", `₦${amtPaid.toLocaleString()} collected from ${loan.fullName}.`);
                closeRepayModal(); fetchLoans(); 
            }
        } catch (e) { alert("Sync Error"); }
    }

    function sendWhatsAppReminder(phone, name, balance) {
        if (!phone) return alert("Phone record missing.");
        const msg = encodeURIComponent(`Hello ${name}, friendly reminder of your ₦${Number(balance).toLocaleString()} balance at Harmony Elite.`);
        window.open(`https://wa.me/${phone.replace(/\D/g,'')}?text=${msg}`, '_blank');
    }

    function exportToCSV() {
        const headers = ["Reference", "Name", "Principal", "Balance", "Status"];
        const rows = allRecords.map(r => [r.trackingId, `"${r.fullName}"`, r.amount, r.balance, r.status]);
        const csv = [headers, ...rows].map(e => e.join(",")).join("\n");
        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob);
        link.download = `Elite_Ledger_${new Date().toLocaleDateString()}.csv`; link.click();
    }

    window.onload = () => {
        // Auth check is first. fetchLoans is called after successful auth.
    };
  </script>
</body>
</html>
