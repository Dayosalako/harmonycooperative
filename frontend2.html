<!DOCTYPE html>                                                            
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Harmony Elite | Front Desk Terminal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f4f7f6; color: #0f172a; }
    .bg-coop-green { background-color: #059669; }
    .text-coop-green { color: #059669; }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.4s ease-out; }
    .nav-link.active { background-color: #ffffff; color: #059669; box-shadow: 0 4px 20px -2px rgba(5, 150, 105, 0.15); transform: translateY(-2px); border: 1px solid #e2e8f0; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
    .premium-gradient { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
  </style>
</head>
<body class="min-h-screen pb-20" onload="authHadiza()">

  <div id="trackingModal" class="fixed inset-0 z-[100] flex items-center justify-center hidden bg-slate-900/40 backdrop-blur-sm p-4">
    <div class="bg-white w-full max-w-md rounded-[2.5rem] p-10 shadow-2xl scale-100 border border-slate-100">
      <div id="modalContent"></div>
      <button onclick="closeModal()" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl hover:bg-black transition mt-8 shadow-lg active:scale-95">Return to Terminal</button>
    </div>
  </div>

  <nav class="sticky top-0 z-50 px-6 lg:px-16 py-5 flex justify-between items-center glass-card border-b border-slate-200">
    <div class="flex items-center space-x-4">
        <div class="w-12 h-12 premium-gradient rounded-2xl flex items-center justify-center text-white text-xl font-black shadow-lg shadow-green-200">H</div>
        <div>
            <span class="block font-extrabold text-xl text-slate-800 tracking-tighter leading-none uppercase">Harmony <span class="text-coop-green">Elite</span></span>
            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] flex items-center">
                <span class="w-2 h-2 bg-emerald-500 rounded-full mr-2 animate-pulse"></span> Terminal Active
            </span>
        </div>
    </div>
    
    <div class="hidden md:flex bg-slate-100/80 p-1.5 rounded-2xl space-x-1 border border-slate-200">
        <button onclick="switchTab('disburse')" id="btn-disburse" class="nav-link active text-[11px] font-black px-8 py-3 rounded-xl transition-all uppercase">Payouts</button>
        <button onclick="switchTab('repay')" id="btn-repay" class="nav-link text-[11px] font-black px-8 py-3 rounded-xl transition-all uppercase">Repayments</button>
        <button onclick="switchTab('logs')" id="btn-logs" class="nav-link text-[11px] font-black px-8 py-3 rounded-xl transition-all uppercase">Journal</button>
    </div>

    <div class="flex items-center space-x-4">
        <div class="text-right hidden sm:block">
            <p id="staffNameDisplay" class="text-sm font-black text-slate-800">Operator</p>
            <p class="text-[9px] font-bold text-slate-400 uppercase">Hadiza S. (Station A)</p>
        </div>
        <button class="w-11 h-11 rounded-2xl bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-500 hover:bg-white transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path></svg>
        </button>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto p-6 lg:p-10">
    
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
        <div class="bg-white p-7 rounded-[2.5rem] shadow-sm border border-slate-200">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Total Payouts</p>
            <h2 id="shiftTotal" class="text-3xl font-black text-slate-900 tracking-tighter">‚Ç¶0.00</h2>
            <p class="text-[10px] font-bold text-emerald-500 mt-2 flex items-center">
                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z"></path></svg> Today's Release
            </p>
        </div>
        <div class="bg-white p-7 rounded-[2.5rem] shadow-sm border border-slate-200">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Debt Recovery</p>
            <h2 id="recoveryTotal" class="text-3xl font-black text-blue-600 tracking-tighter">‚Ç¶0.00</h2>
            <div class="mt-3 h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                <div id="recoveryProgress" class="h-full bg-blue-500 transition-all duration-1000" style="width: 0%"></div>
            </div>
        </div>
        <div class="md:col-span-2 bg-slate-900 p-2 rounded-[2.5rem] flex shadow-2xl shadow-slate-300">
            <input type="text" id="frontTrackInput" onkeyup="liveSearch()" placeholder="Search member name or tracking ID..." class="flex-1 bg-transparent px-8 py-5 text-white font-bold text-sm outline-none placeholder:text-slate-500">
            <button onclick="frontTrack()" class="bg-coop-green text-white px-10 py-4 rounded-[2rem] font-bold text-xs hover:bg-emerald-500 transition shadow-lg m-1">TRACK RECORD</button>
        </div>
    </div>

    <section id="disburseTab" class="tab-content active">
        <div class="bg-white rounded-[3rem] shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden">
            <div class="p-10 border-b flex justify-between items-center bg-slate-50/30">
                <div>
                    <h3 class="text-2xl font-black text-slate-800 tracking-tight">Pending Payouts</h3>
                    <p class="text-sm text-slate-400 font-medium">Verified by Super Admin ‚Ä¢ Ready for Cash Release</p>
                </div>
                <button onclick="loadFrontDeskData()" class="bg-white text-[10px] font-black border border-slate-200 px-8 py-4 rounded-2xl hover:bg-slate-50 transition-all uppercase tracking-widest shadow-sm">Sync Server</button>
            </div>
            <div id="payoutList" class="divide-y divide-slate-50">
                <div class="p-24 text-center text-slate-300 animate-pulse font-bold uppercase tracking-widest text-xs">Awaiting Data Stream...</div>
            </div>
        </div>
    </section>

    <div class="flex justify-between items-end mb-12">
    <div>
        <h3 class="text-3xl font-black text-slate-900 tracking-tighter italic">Debt Recovery Portal</h3>
        <p class="text-slate-500 font-medium mt-1 text-lg">Manage active member loan balances and post settlements</p>
    </div>
    <div class="flex flex-col items-end gap-3">
        <button onclick="exportDebtCSV()" class="bg-emerald-50 text-emerald-700 border border-emerald-200 px-6 py-3 rounded-xl text-[10px] font-black hover:bg-emerald-600 hover:text-white transition-all shadow-sm flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            EXPORT COLLECTION LIST (CSV)
        </button>
        <span class="bg-slate-900 text-white text-[10px] px-3 py-1 rounded-md font-bold uppercase tracking-tighter italic">ISO-20022 Compliant</span>
    </div>
</div>
    
    <section id="repayTab" class="tab-content">
        <div class="bg-white rounded-[3rem] p-10 border border-slate-100 shadow-xl shadow-slate-200/50">
            <div class="flex justify-between items-end mb-12">
                <div>
                    
                    <p class="text-slate-500 font-medium mt-1 text-lg">Manage active member loan balances and post settlements</p>
                </div>
                <div class="text-right">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Global Standard</span>
                    <span class="bg-slate-900 text-white text-[10px] px-3 py-1 rounded-md font-bold">ISO-20022 COMPLIANT</span>
                </div>
            </div>
            <div id="repaymentList" class="grid grid-cols-1 lg:grid-cols-2 gap-8"></div>
        </div>
    </section>

    <section id="logsTab" class="tab-content">
        <div class="bg-white rounded-[3rem] shadow-xl border border-slate-100 overflow-hidden">
            <div class="p-10 border-b flex justify-between items-center bg-slate-900 text-white">
                <div>
                    <h3 class="text-2xl font-black tracking-tight">Station Journal</h3>
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.3em] mt-1">Legally binding shift history</p>
                </div>
                <button onclick="printStationLog()" class="bg-white text-slate-900 px-10 py-4 rounded-2xl text-[11px] font-black hover:bg-slate-100 transition shadow-lg uppercase">Export Full Log (PDF)</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-50/50 border-b border-slate-100 font-black text-[10px] uppercase tracking-widest text-slate-400">
                        <tr>
                            <th class="px-10 py-7">Member Name</th>
                            <th class="px-10 py-7">ID Reference</th>
                            <th class="px-10 py-7">Amount</th>
                            <th class="px-10 py-7">Lifecycle</th>
                            <th class="px-10 py-7">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="logsContainer" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
        </div>
    </section>

  </main>

  <script>
    const API_URL = 'https://sheetdb.io/api/v1/b9cm231d1i0he';
    let records = [];

    async function authHadiza() {
        const pin = prompt("üîê SECURE ACCESS PANEL\nEnter Operator PIN:");
        if(pin === "1234") { 
            document.getElementById('staffNameDisplay').innerText = "Hadiza S.";
            loadFrontDeskData();
        } else {
            alert("Unauthorized access detected.");
            window.location.reload();
        }
    }

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById(id + 'Tab').classList.add('active');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById('btn-' + id).classList.add('active');
    }

    async function loadFrontDeskData() {
        try {
            const res = await fetch(API_URL);
            records = await res.json();
            renderPayouts();
            renderRepayments();
            renderLogs();
            calculateIntelligence();
        } catch (e) { alert("Server Sync Error"); }
    }

    function calculateIntelligence() {
        const payouts = records.filter(r => r.status === 'Paid');
        const payoutSum = payouts.reduce((a, b) => a + (Number(b.amount) || 0), 0);
        const debtSum = records.reduce((a, b) => a + (Number(b.balance) || 0), 0);
      const highExposureCount = records.filter(r => Number(r.balance) > 500000).length;
// You can now display this count somewhere in your UI if you choose
        
        document.getElementById('shiftTotal').innerText = `‚Ç¶${payoutSum.toLocaleString()}`;
        document.getElementById('recoveryTotal').innerText = `‚Ç¶${debtSum.toLocaleString()}`;
        
        const progress = Math.min((payoutSum / 1000000) * 100, 100);
        document.getElementById('recoveryProgress').style.width = progress + "%";
    }

    function renderPayouts() {
    const list = document.getElementById('payoutList');
    // Filter for both Approved (ready) and Processing (new) to show a full queue
    const pending = records.filter(r => r.status === 'Approved' || r.status === 'Processing');
    
    if (pending.length === 0) {
        list.innerHTML = `<div class="p-32 text-center text-slate-300 italic font-bold uppercase tracking-widest">All Payouts Completed / No Pending Records</div>`;
        return;
    }

    list.innerHTML = pending.map(loan => {
        const isApproved = loan.status === 'Approved';
        
        return `
            <div class="p-10 hover:bg-slate-50 transition-all flex flex-col md:flex-row justify-between items-center gap-8 group search-item border-b border-slate-50">
                <div class="flex items-center space-x-8">
                    <div class="w-16 h-16 ${isApproved ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-blue-50 text-blue-600 border-blue-100'} rounded-2xl flex items-center justify-center text-2xl font-black border">‚Ç¶</div>
                    <div>
                        <div class="text-xl font-black text-slate-900 tracking-tight leading-none mb-2 uppercase">${loan.fullName}</div>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-mono font-bold text-slate-400 uppercase tracking-widest">${loan.trackingId}</span>
                            <span class="px-2 py-0.5 rounded text-[8px] font-black uppercase border ${
                                isApproved 
                                ? 'bg-emerald-100 text-emerald-700 border-emerald-200' 
                                : 'bg-blue-100 text-blue-700 border-blue-200'
                            }">
                                ${loan.status}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="text-center md:text-left flex-1 px-10 border-x border-slate-100/50">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] mb-2">Recipient Bank Details</p>
                    <p class="text-sm font-bold text-slate-700 uppercase">
                        ${loan.bankName || 'N/A'} 
                        <span class="${isApproved ? 'text-emerald-600' : 'text-blue-600'} mx-2">|</span> 
                        ${loan.accNum || 'XXXXXXXXXX'}
                    </p>
                </div>

                <div class="text-center md:text-right min-w-[150px]">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">Disbursement Sum</p>
                    <p class="text-3xl font-black text-slate-900 tracking-tighter">‚Ç¶${Number(loan.amount).toLocaleString()}</p>
                </div>

                <button onclick="secureAction(() => confirmPayout('${loan.trackingId}'), 'CASH DISBURSEMENT')" 
                        class="${isApproved ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-slate-900 hover:bg-black'} text-white px-10 py-5 rounded-2xl font-black text-[11px] transition shadow-xl uppercase tracking-widest active:scale-95 disabled:opacity-50"
                        ${!isApproved ? 'title="Awaiting Admin Final Approval"' : ''}>
                    ${isApproved ? 'Release Cash' : 'Verify & Hold'}
                </button>
            </div>
        `;
    }).join('');
}  

    function renderRepayments() {
    const container = document.getElementById('repaymentList');
    // Logic: Only show members who still have a debt balance
    const activeLoans = records.filter(r => Number(r.balance) > 0);
    
    if (activeLoans.length === 0) {
        container.innerHTML = `<p class="col-span-full text-center py-20 text-slate-300 font-bold uppercase tracking-widest">No Active Debt Records Found.</p>`;
        return;
    }

    container.innerHTML = activeLoans.map(loan => {
        const isHighDebt = Number(loan.balance) > 500000; // Red alert threshold
        
        return `
            <div class="p-8 bg-slate-50/50 rounded-[2.5rem] border-2 ${isHighDebt ? 'border-rose-500 bg-rose-50/30' : 'border-slate-200'} hover:bg-white transition-all duration-300 search-item group relative overflow-hidden">
                
                ${isHighDebt ? `
                    <div class="absolute top-0 right-0 bg-rose-500 text-white text-[8px] font-black px-4 py-1 rounded-bl-xl tracking-widest animate-pulse">
                        HIGH EXPOSURE
                    </div>
                ` : ''}

                <div class="flex justify-between items-start mb-8">
                    <div class="w-12 h-12 ${isHighDebt ? 'bg-rose-600' : 'bg-slate-900'} text-white rounded-2xl flex items-center justify-center font-black text-lg shadow-lg">${loan.fullName.charAt(0)}</div>
                    
                    <div class="flex items-center gap-2">
                        <button onclick="sendWhatsAppReminder('${loan.phone}', '${loan.fullName}', '${loan.balance}')" 
                                title="Send WhatsApp Reminder"
                                class="bg-emerald-100 text-emerald-700 p-3 rounded-xl hover:bg-emerald-600 hover:text-white transition-all shadow-sm">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.438 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981z"/>
                            </svg>
                        </button>

                        <button onclick='generateLoanStatement(${JSON.stringify(loan)})' 
                                class="bg-slate-200 text-slate-700 p-3 rounded-xl hover:bg-slate-900 hover:text-white transition-all shadow-sm flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span class="text-[9px] font-black uppercase hidden sm:block">Statement</span>
                        </button>
                    </div>
                </div>

                <div class="mb-8">
                    <h4 class="font-black text-slate-900 text-xl leading-tight uppercase mb-1">${loan.fullName}</h4>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">${loan.trackingId}</span>
                        <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-tight italic">${loan.phone || 'No Phone Linked'}</p>
                    </div>
                </div>

                <div class="${isHighDebt ? 'bg-white/80' : 'bg-white'} p-6 rounded-3xl shadow-sm border ${isHighDebt ? 'border-rose-200' : 'border-slate-100'} mb-8">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Current Balance Due</p>
                    <p class="text-3xl font-black ${isHighDebt ? 'text-rose-600' : 'text-slate-900'} tracking-tighter">
                        ‚Ç¶${Number(loan.balance).toLocaleString()}
                    </p>
                </div>

                <div class="flex items-center space-x-3">
                    <div class="relative flex-1">
                        <span class="absolute left-5 top-1/2 -translate-y-1/2 font-black text-slate-400 text-sm">‚Ç¶</span>
                        <input type="number" id="pay-${loan.trackingId}" placeholder="Payment amount..." class="w-full pl-10 pr-5 py-5 rounded-2xl bg-white border border-slate-200 outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 font-bold text-sm">
                    </div>
                    <button onclick="secureAction(() => processRepayment('${loan.trackingId}'), 'POST REPAYMENT')" 
                            class="bg-emerald-600 text-white px-8 py-5 rounded-2xl font-black text-[11px] shadow-lg hover:bg-emerald-700 transition uppercase tracking-widest active:scale-95">
                        Post Payment
                    </button>
                </div>
            </div>
        `;
    }).join('');
}
    
    function renderLogs() {
        const container = document.getElementById('logsContainer');
        container.innerHTML = records.map(r => `
            <tr class="hover:bg-slate-50 transition-colors search-item">
                <td class="px-10 py-7 font-black text-slate-800 text-sm uppercase">${r.fullName}</td>
                <td class="px-10 py-7 font-mono text-[10px] font-bold text-slate-400 uppercase tracking-widest">${r.trackingId}</td>
                <td class="px-10 py-7 font-black text-sm">‚Ç¶${Number(r.amount).toLocaleString()}</td>
                <td class="px-10 py-7">
                    <span class="px-4 py-2 rounded-xl text-[9px] font-black uppercase border ${
    r.status === 'Paid' ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 
    r.status === 'Processing' ? 'bg-blue-50 text-blue-600 border-blue-100' : 
    'bg-orange-50 text-orange-600 border-orange-100'
}">
    ${r.status}
</span>
                </td>
                <td class="px-10 py-7">
                    <button onclick="reprintReceipt('${r.trackingId}')" class="flex items-center space-x-2 text-slate-900 bg-slate-100 px-4 py-2 rounded-xl text-[10px] font-black hover:bg-slate-900 hover:text-white transition uppercase">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                        <span>Receipt</span>
                    </button>
                </td>
            </tr>
        `).reverse().join('');
    }

    async function confirmPayout(id) {
        if(!confirm("CONFIRMATION: Are you physically handing over cash or verifying a successful bank transfer?")) return;
        const response = await fetch(`${API_URL}/trackingId/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: { status: 'Paid' } })
        });
        if(response.ok) {
            const loan = records.find(r => r.trackingId === id);
            generatePremiumReceipt(loan, "DISBURSEMENT");
            loadFrontDeskData();
        }
    }

    async function processRepayment(id) {
        const val = document.getElementById(`pay-${id}`).value;
        if(!val || val <= 0) return alert("Enter valid recovery sum.");
        const loan = records.find(r => r.trackingId === id);
        const newBal = Number(loan.balance) - Number(val);
        
        const response = await fetch(`${API_URL}/trackingId/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: { balance: newBal } })
        });

        if(response.ok) {
            generatePremiumReceipt({...loan, amount: val, balance: newBal}, "REPAYMENT");
            loadFrontDeskData();
            alert("Repayment Recorded Successfully.");
        }
    }

    function reprintReceipt(id) {
        const r = records.find(rec => rec.trackingId === id);
        generatePremiumReceipt(r, r.status === 'Paid' ? "DISBURSEMENT" : "REPAYMENT");
    }

    function liveSearch() {
        const val = document.getElementById('frontTrackInput').value.toLowerCase();
        document.querySelectorAll('.search-item').forEach(item => {
            item.style.display = item.innerText.toLowerCase().includes(val) ? '' : 'none';
        });
    }

    function frontTrack() {
        const id = document.getElementById('frontTrackInput').value.trim().toUpperCase();
        const loan = records.find(r => r.trackingId === id || r.fullName.toUpperCase().includes(id));
        if(!loan) return alert("System Record Not Found.");
        
        document.getElementById('modalContent').innerHTML = `
            <div class="text-center mb-8">
                <div class="w-20 h-20 premium-gradient text-white rounded-full flex items-center justify-center text-3xl mx-auto mb-4 font-black shadow-xl">H</div>
                <h4 class="text-3xl font-black text-slate-900 tracking-tighter uppercase leading-none mb-1">${loan.fullName}</h4>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${loan.trackingId}</p>
            </div>
            <div>
    <div class="text-xl font-black text-slate-900 tracking-tight leading-none mb-2 uppercase">${loan.fullName}</div>
    <div class="flex items-center gap-2">
        <span class="text-[10px] font-mono font-bold text-slate-400 uppercase tracking-widest">${loan.trackingId}</span>
        <span class="px-2 py-0.5 rounded text-[8px] font-black uppercase border ${
            loan.status === 'Approved' 
            ? 'bg-emerald-100 text-emerald-700 border-emerald-200' 
            : 'bg-blue-100 text-blue-700 border-blue-200'
        }">
            ${loan.status}
        </span>
    </div>
</div>
                <div class="p-6 bg-slate-50 rounded-3xl flex justify-between items-center border border-slate-100">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Outstanding Debt</span>
                    <span class="text-xl font-black text-red-500">‚Ç¶${Number(loan.balance).toLocaleString()}</span>
                </div>
            </div>
        `;
        document.getElementById('trackingModal').classList.remove('hidden');
    }

    function closeModal() { document.getElementById('trackingModal').classList.add('hidden'); }

    // PREMIUM PDF GENERATOR (Global Standard)
    function generatePremiumReceipt(data, type) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const timestamp = new Date().toLocaleString();

        // Design Elements
        doc.setFillColor(15, 23, 42); // Slate 900
        doc.rect(0, 0, 210, 60, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(28);
        doc.text("HARMONY ELITE", 25, 30);
        
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text("COOPERATIVE FINANCIAL SERVICES", 25, 40);
        doc.text(`OFFICIAL ${type} VOUCHER`, 185, 40, {align: 'right'});

        // Receipt Content
        doc.setTextColor(15, 23, 42);
        doc.setFontSize(10);
        doc.text("TRANSACTION REFERENCE", 25, 80);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text(data.trackingId, 25, 87);

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text("DATE & TIME", 185, 80, {align: 'right'});
        doc.setFont("helvetica", "bold");
        doc.text(timestamp, 185, 87, {align: 'right'});

        // Main Box
        doc.setFillColor(248, 250, 252);
        doc.rect(20, 100, 170, 80, 'F');
        doc.setDrawColor(226, 232, 240);
        doc.rect(20, 100, 170, 80, 'D');

        doc.setTextColor(100);
        doc.setFontSize(9);
        doc.text("BENEFICIARY NAME", 35, 120);
        doc.setTextColor(15, 23, 42);
        doc.setFontSize(14);
        doc.text(data.fullName.toUpperCase(), 35, 130);

        doc.setTextColor(100);
        doc.setFontSize(9);
        doc.text("TRANSACTION SUM", 35, 150);
        doc.setTextColor(5, 150, 105); // Emerald Green
        doc.setFontSize(26);
        doc.text(`NGN ${Number(data.amount).toLocaleString()}`, 35, 165);

        if(type === "REPAYMENT") {
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(10);
            doc.text("REMAINING BALANCE:", 180, 165, {align: 'right'});
            doc.setFontSize(14);
            doc.setTextColor(220, 38, 38);
            doc.text(`NGN ${Number(data.balance).toLocaleString()}`, 180, 175, {align: 'right'});
        }

        // Security Footnote
        doc.setTextColor(150);
        doc.setFontSize(8);
        doc.setFont("helvetica", "italic");
        doc.text("This document is a computer-generated transaction receipt from the Harmony Front Desk Terminal.", 105, 260, {align: 'center'});
        doc.text("Verification Hash: " + btoa(data.trackingId + timestamp).substring(0, 16), 105, 265, {align: 'center'});

        doc.save(`${type}_${data.trackingId}.pdf`);
    }

    function printStationLog() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(22); doc.text("STATION JOURNAL - TERMINAL 01-A", 15, 25);
        doc.setFontSize(10); doc.text(`Generated by Hadiza S. on ${new Date().toLocaleString()}`, 15, 32);
        
        let y = 50;
        doc.setFont("helvetica", "bold");
        doc.text("REF ID", 15, y); doc.text("MEMBER", 60, y); doc.text("AMOUNT", 140, y); doc.text("STATUS", 180, y);
        doc.line(15, y+2, 195, y+2);
        
        y += 10;
        records.forEach(r => {
            doc.setFont("helvetica", "normal");
            doc.text(r.trackingId, 15, y);
            doc.text(r.fullName.substring(0, 25), 60, y);
            doc.text(`N${Number(r.amount).toLocaleString()}`, 140, y);
            doc.text(r.status, 180, y);
            y += 8;
        });
        doc.save("Harmony_Shift_Log.pdf");
    }

    function exportDebtCSV() {
    const activeDebts = records.filter(r => Number(r.balance) > 0);
    
    if (activeDebts.length === 0) return alert("No active debts found to export.");

    // Define CSV Headers
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Tracking ID,Member Name,Phone,Total Loan,Current Balance,Status\r\n";

    // Add Row Data
    activeDebts.forEach(r => {
        const row = [
            r.trackingId,
            r.fullName,
            r.phone || 'N/A',
            r.totalRepayment,
            r.balance,
            r.status
        ].join(",");
        csvContent += row + "\r\n";
    });

    // Create Download Link
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `Harmony_Debt_List_${new Date().toLocaleDateString()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    function generateLoanStatement(loan) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const totalPaid = Number(loan.totalRepayment) - Number(loan.balance);
    const date = new Date().toLocaleDateString();

    // Header Design
    doc.setFillColor(15, 23, 42); // Slate 900
    doc.rect(0, 0, 210, 40, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(22);
    doc.text("LOAN ACCOUNT STATEMENT", 20, 25);
    
    // Member Info
    doc.setTextColor(15, 23, 42);
    doc.setFontSize(10);
    doc.text(`MEMBER: ${loan.fullName.toUpperCase()}`, 20, 55);
    doc.text(`TRACKING ID: ${loan.trackingId}`, 20, 62);
    doc.text(`STATEMENT DATE: ${date}`, 190, 55, {align: 'right'});

    // Summary Table Header
    doc.setFillColor(248, 250, 252);
    doc.rect(20, 75, 170, 45, 'F');
    doc.setDrawColor(226, 232, 240);
    doc.rect(20, 75, 170, 45, 'D');

    // Financial Breakdown
    doc.setFont("helvetica", "bold");
    doc.text("DESCRIPTION", 30, 85);
    doc.text("AMOUNT (NGN)", 180, 85, {align: 'right'});
    doc.line(30, 88, 180, 88);

    doc.setFont("helvetica", "normal");
    doc.text("Original Loan Liability", 30, 98);
    doc.text(`${Number(loan.totalRepayment).toLocaleString()}`, 180, 98, {align: 'right'});

    doc.text("Total Repayments Post-Disbursement", 30, 108);
    doc.setTextColor(5, 150, 105); // Green
    doc.text(`- ${totalPaid.toLocaleString()}`, 180, 108, {align: 'right'});

    // Final Balance
    doc.setTextColor(220, 38, 38); // Red
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.text("CURRENT OUTSTANDING BALANCE", 30, 135);
    doc.text(`NGN ${Number(loan.balance).toLocaleString()}`, 180, 135, {align: 'right'});

    // Verification Footnote
    doc.setFontSize(8);
    doc.setTextColor(150);
    doc.text("This statement is a certified digital record of Harmony Elite Cooperative.", 105, 160, {align: 'center'});

    doc.save(`Statement_${loan.trackingId}.pdf`);
}
    // The Security Gatekeeper
async function secureAction(callback, actionName) {
    const pin = prompt(`üîê SECURITY VERIFICATION\nAction: ${actionName}\nEnter your 4-digit Operator PIN to authorize:`);
    
    if (pin === "1234") { // Matches the authHadiza PIN
        callback();
    } else {
        alert("‚ùå Access Denied: Incorrect PIN. Transaction aborted.");
    }
}

    function closeShift() {
    // Filter records processed during this session
    const totalOut = records
        .filter(r => r.status === 'Paid')
        .reduce((sum, r) => sum + (Number(r.amount) || 0), 0);
        
    const totalIn = records
        .reduce((sum, r) => {
            // This assumes we track session repayments. 
            // For now, we'll show the global recovery total.
            return sum + (Number(r.totalRepayment - r.balance) || 0);
        }, 0);

    const netFlow = totalIn - totalOut;

    document.getElementById('modalContent').innerHTML = `
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-slate-900 text-white rounded-2xl flex items-center justify-center text-2xl mx-auto mb-4 font-black">Œ£</div>
            <h4 class="text-2xl font-black text-slate-900 tracking-tighter uppercase">Shift Summary</h4>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${new Date().toLocaleDateString()} | Terminal 01-A</p>
        </div>
        <div class="space-y-3">
            <div class="p-5 bg-emerald-50 rounded-2xl border border-emerald-100 flex justify-between">
                <span class="text-[10px] font-black text-emerald-700 uppercase">Total Recovered (IN)</span>
                <span class="font-bold text-emerald-700">‚Ç¶${totalIn.toLocaleString()}</span>
            </div>
            <div class="p-5 bg-rose-50 rounded-2xl border border-rose-100 flex justify-between">
                <span class="text-[10px] font-black text-rose-700 uppercase">Total Disbursed (OUT)</span>
                <span class="font-bold text-rose-700">‚Ç¶${totalOut.toLocaleString()}</span>
            </div>
            <div class="p-6 bg-slate-900 rounded-3xl mt-4 text-white">
                <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Net Cash Position</p>
                <p class="text-2xl font-black">${netFlow >= 0 ? '+' : ''}‚Ç¶${netFlow.toLocaleString()}</p>
            </div>                                                            
        </div>
        <p class="text-[9px] text-slate-400 italic text-center mt-6">Please verify physical cash against these figures before exiting.</p>
    `;
    document.getElementById('trackingModal').classList.remove('hidden');
}
    function sendWhatsAppReminder(phone, name, balance) {
    if (!phone || phone === "N/A") return alert("No phone linked.");
    const cleanPhone = phone.replace(/\D/g, '');
    const message = encodeURIComponent(`Hello ${name}, reminder of your ‚Ç¶${Number(balance).toLocaleString()} balance at Harmony Elite.`);
    window.open(`https://wa.me/${cleanPhone}?text=${message}`, '_blank');
}
    function sendWhatsAppReminder(phone, name, balance) {
    if (!phone || phone === "N/A" || phone === "") {
        return alert("‚ùå Error: No phone number linked to this member record.");
    }

    // Sanitize: Remove any non-numeric characters (spaces, dashes, etc.)
    const cleanPhone = phone.replace(/\D/g, '');
    
    // Create the professional message template
    const message = `Hello ${name}, this is a friendly reminder from Harmony Elite Cooperative regarding your outstanding loan balance of ‚Ç¶${Number(balance).toLocaleString()}. Please visit Station A or contact us for repayment. Thank you.`;
    
    // Encode the text for a URL
    const encodedMessage = encodeURIComponent(message);
    
    // Open WhatsApp Web or Mobile App in a new tab
    window.open(`https://wa.me/${cleanPhone}?text=${encodedMessage}`, '_blank');
}
    
  </script>
</body>

</html>

